import{onMouseDown,onMouseLeave,onMouseMove,onMouseUp,onTouchMove}from"./utils/mouseHandlers";export class Snapgrab{constructor(e,t={}){this.element=e,this.wrapper=this.element.querySelector('[data-ref="wrapper"]'),this.dots=this.element.querySelector('[data-ref="dots"]'),this.prev=this.element.querySelector('[data-ref="prev"]'),this.next=this.element.querySelector('[data-ref="next"]'),this.isDragging=!1,this.isScrolling=!1,this.startX=0,this.scrollLeft=0,this.startY=0,this.isVerticalScroll=!1,this.options=t,this.state={isDragging:this.isDragging,startX:this.startX,scrollLeft:this.scrollLeft,currentSlide:0},this.bindEvents()}bindEvents(){this.onMouseDown=e=>this.handleMouseDown(e),this.onMouseMove=e=>this.handleMouseMove(e),this.onMouseUp=e=>this.handleMouseUp(e),this.onMouseLeave=()=>this.handleMouseLeave(),this.onScroll=this.debounce((()=>this.detectCurrentSlide()),100),this.onTouchMove=e=>onTouchMove(e,this,this.state),this.wrapper.addEventListener("mousedown",this.onMouseDown),this.wrapper.addEventListener("mousemove",this.onMouseMove),this.wrapper.addEventListener("mouseup",this.onMouseUp),this.wrapper.addEventListener("mouseleave",this.onMouseLeave),this.wrapper.addEventListener("scroll",this.onScroll),this.wrapper.addEventListener("touchstart",(e=>this.onTouchStart(e)),{passive:!0}),this.wrapper.addEventListener("touchmove",this.onTouchMove,{passive:!0}),this.wrapper.addEventListener("touchend",this.onMouseUp),this.prev?.addEventListener("click",(()=>this.handlePrevClick())),this.next?.addEventListener("click",(()=>this.handleNextClick())),this.wrapper.addEventListener("slideChange",(()=>this.handleHeight())),window.addEventListener("resize",this.handleHeight.bind(this))}init(){this.preventImageDragging(),this.updateButtonState(),this.handleHeight(),this.createDots(),this.detectCurrentSlide();this.wrapper.children.length>1?this.wrapper.style.cursor="grab":(this.dots&&(this.dots.style.display="none"),this.prev&&(this.prev.style.display="none"),this.next&&(this.next.style.display="none")),this.element.classList.add("loaded")}preventImageDragging(){this.wrapper.querySelectorAll("img").forEach((e=>{e.setAttribute("draggable","false"),e.addEventListener("load",(()=>this.handleHeight()))}))}onTouchStart(e){this.isDragging=!0,this.startX=e.touches[0].pageX-this.wrapper.offsetLeft,this.scrollLeft=this.wrapper.scrollLeft,this.startY=e.touches[0].pageY,this.isVerticalScroll=!1}handleMouseDown(e){this.wrapper.children.length>1&&(onMouseDown(e,this,this.state),this.isScrolling=!1,this.wrapper.style.cursor="grabbing")}handleMouseUp(e){this.wrapper.children.length>1&&(onMouseUp(this,this.state),this.isScrolling||this.handleSlideChange(),this.isScrolling=!1,this.wrapper.style.cursor="grab")}handleMouseLeave(){this.wrapper.children.length>1&&(onMouseLeave(this,this.state),this.wrapper.style.cursor="grab")}handleMouseMove(e){onMouseMove(e,this,this.state),this.isScrolling=!0}detectCurrentSlide(){const e=this.wrapper.children[0].offsetWidth,t=Math.floor(this.wrapper.offsetWidth/e),s=Math.round(this.wrapper.scrollLeft/e),i=s+t-1;s!==this.state.currentSlide?(this.state.currentSlide=s,this.state.visibleSlides=t,this.updateAriaHidden(),this.updateButtonState(),this.updateActiveDot(s,i),this.triggerSlideChangeEvent(s)):this.updateButtonState()}handleSlideChange(){const e=Math.round(this.wrapper.scrollLeft/this.wrapper.offsetWidth);e!==this.state.currentSlide&&(this.state.currentSlide=e,this.updateAriaHidden(),this.updateButtonState(),this.triggerSlideChangeEvent(e),this.handleHeight())}updateAriaHidden(){this.wrapper.querySelectorAll(".testimonial__slide").forEach(((e,t)=>{e.setAttribute("aria-hidden",t!==this.state.currentSlide)}))}triggerSlideChangeEvent(e){const t=new CustomEvent("slideChange",{detail:{slideIndex:e}});this.wrapper.dispatchEvent(t),this.options.onSlideChange&&this.options.onSlideChange(e)}handleHeight(){const e=this.wrapper.children[this.state.currentSlide];if(!e)return;const t=window.getComputedStyle(e),s=parseFloat(t.paddingTop)||0,i=parseFloat(t.paddingBottom)||0;let r=Array.from(e.children).reduce(((e,t)=>{const s=t.getBoundingClientRect().height,i=window.getComputedStyle(t);return e+s+(parseFloat(i.marginTop)||0)+(parseFloat(i.marginBottom)||0)}),0);if(r+=s+i,t.display.includes("flex")){r+=(parseFloat(t.rowGap)||0)*(e.children.length-1)}else if(t.display.includes("grid")){const s=Array.from(e.children).reduce(((e,s,i)=>(e[i%t.gridTemplateColumns.split(" ").length]+=s.getBoundingClientRect().height,e)),Array(t.gridTemplateColumns.split(" ").length).fill(0));r=Math.max(...s)}this.wrapper.style.height=`${r}px`,this.wrapper.offsetHeight}handlePrevClick(){this.scrollSlides(-1)}handleNextClick(){this.scrollSlides(1)}scrollSlides(e){const t=this.wrapper.children[0]?.offsetWidth||0,s=this.wrapper.scrollLeft+e*t;this.updateButtonState(),this.wrapper.scrollTo({left:s,behavior:"smooth"}),this.detectCurrentSlide()}debounce(e,t){let s;return(...i)=>{clearTimeout(s),s=setTimeout((()=>e.apply(this,i)),t)}}updateButtonState(){const e=this.wrapper.children[0]?.offsetWidth||0,t=Math.floor(this.wrapper.offsetWidth/e),s=(this.wrapper.children.length-t)*e;this.prev?.toggleAttribute("disabled",this.wrapper.scrollLeft<=0),this.next?.toggleAttribute("disabled",this.wrapper.scrollLeft>=s)}createDots(){if(!this.dots)return;const e=this.wrapper.children.length;this.dots.innerHTML="";for(let t=0;t<e;t++){const e=document.createElement("button");e.className="dot",e.addEventListener("click",(()=>this.goToSlide(t))),this.dots.appendChild(e)}const t=this.wrapper.children[0]?.offsetWidth||0,s=parseFloat(window.getComputedStyle(this.wrapper).gap)||0,i=Math.floor(this.wrapper.offsetWidth/(t+s));this.state.visibleSlides=i,console.log("Visible Slides on Init:",i,"Total Slides:",e),this.updateActiveDot(0,i-1)}updateActiveDot(e,t){if(!this.dots)return;const s=this.dots.querySelectorAll("button"),i=s.length,r=this.state.visibleSlides;s.forEach(((s,o)=>{let h=o>=e&&o<=t;t>=i-1&&(h=o>=i-r),s.classList.toggle("is-active",h)}))}goToSlide(e){const t=e*this.wrapper.offsetWidth;this.wrapper.scrollTo({left:t,behavior:"smooth"}),this.detectCurrentSlide()}destroy(){this.wrapper.removeEventListener("mousedown",this.onMouseDown),this.wrapper.removeEventListener("mousemove",this.onMouseMove),this.wrapper.removeEventListener("mouseup",this.onMouseUp),this.wrapper.removeEventListener("mouseleave",this.onMouseLeave),this.wrapper.removeEventListener("scroll",this.onScroll)}}